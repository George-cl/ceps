# Signer Vault Recovery

## Summary

[summary]: #summary

CEP PR: [casperlabs/ceps#0072](https://github.com/casper-network/ceps/pull/72)

Currently keypairs generated by the Signer but not backed up are unrecoverable if the **Vault Password** is lost/forgotten. This CEP adds a recovery method in the form of a **Secret Phrase** that is used in the generation of deterministic keys and as such can recover keypairs in the event that the **Vault Password** is lost or forgotten.

## Motivation

[motivation]: #motivation

Many users are losing access to funds because they aren't backing up keys and subsequently forget their **Vault Password**. This CEP should reduce the chances of this happening as users will be forced to take down their **Secret Phrase** prior to the creation of any keypairs by the Signer.  
Another benefit is that users can opt to store only the **Secret Phrase** instead of downloading secret key files which can be vulnerable to theft.

## Guide-level explanation

[guide-level-explanation]: #guide-level-explanation

### Definitions 
- **Vault Password**: The password set by the user when the vault is created. It is used to encrypt the vault data in the browser.
- **Secret Phrase**: The 12<sup>[1][unresolved-questions]</sup> word phrase generated by the Signer on initialisation of a new Vault.

### Flow
A user starts out by installing the extension from the [Chrome Web Store][signer_link].
Once installed they are prompted to set the **Vault Password** and will be presented with their new **Secret Phrase** (they can also recover keypairs with an existing **Secret Phrase** at this point).  
They will be instructed to take note of the 12<sup>[1][unresolved-questions]</sup> words by writing it down and storing it securely or save it in a password manager.  
In the next screen the user needs to confirm the phrase by typing it in order (copying/pasting will be disabled), this is to ensure they have stored it somewhere other than their clipboard. Failure to correctly provide the **Secret Phrase** would prevent the keypair from being created and stored in the Vault - **the user is required to confirm their Secret Phrase to initialise the Vault**.  
Having confirmed the **Secret Phrase**, the user is directed to the home screen with a single keypair in their vault.

## Reference-level explanation

[reference-level-explanation]: #reference-level-explanation

When the vault is created the user needs to enter a password that will be used to encrypt the vault data in the Chrome Storage API.
The Signer will generate a 12<sup>[1][unresolved-questions]</sup> word phrase based on the [BIP-0039][bip-39_wiki] wordlists. I propose using the [bip39][bip39_js] NPM package to [generate](https://github.com/bitcoinjs/bip39/blob/200c6a93ba0bf946d982e133a00a2c081240af9a/src/index.js#L139 "generateMnemonic function") the **Secret Phrase** and [convert](https://github.com/bitcoinjs/bip39/blob/5faee2c17b2195f30b03cb125df68c20d7dd584b/src/index.js#L58 "mnemonicToSeed function") it to a seed used to [deterministically generate](https://github.com/dchest/tweetnacl-js/blob/f1ec050ceae0861f34280e62498b1d3ed9c350c6/nacl.js#L1113 "fromSeed function") a keypair.

In the event that the **Vault Password** is lost or forgotten the user can reset the Vault (clearing all data therein) and re-initialise it, entering a new **Vault Password** and using their **Secret Phrase** to recover their keypairs.

## Drawbacks

[drawbacks]: #drawbacks

There is a non-trivial amount of work involved in the implementation as well as the introduction of potential security risks to what is otherwise a very secure setup.  
It is also another secret for users to manage (in addition to the current **Vault Password**).

In the CEP's current state there would need to be a **Secret Phrase** per keypair which could be an inconvenience for users looking to manage multiple keypairs.  
See the [future possibilities][future-possibilities] section for a potential enhancement.

## Rationale and alternatives

[rationale-and-alternatives]: #rationale-and-alternatives

This implementation for recovery of keypairs is already being used by many entities e.g. [MetaMask][metamask].
Alternative methods used in non-blockchain services such as **email** or **phone number** may not be as acceptable to a community who value anonymity.

Another alternative would be to actively and strongly encourage users to download their Signer generated keys immediately after creation. There could be an option to 'Skip' but it would be made clear that this is at the user's own risk. Something similar exists in [MetaMask][metamask] but applied to the backup of the Secret Recovery Phrase (since it doesn't support downloading actual key files). 

## Prior art

[prior-art]: #prior-art

MetaMask had some issues with terminology when they referred to it as a "Seed Phrase". It didn't imply the significance of the data and some users shared it with malicious parties who were then able to take control of the user's accounts. They recently opted to rename it a "Secret Recovery Phrase" and I think our terminology of **Secret Phrase** should adequately communicate the sensitive nature of the data.  
Using mnemonics/phrases to recover keys is common throughout the crypto space as it requires no personal/contact information to perform the recovery.

## Unresolved questions

[unresolved-questions]: #unresolved-questions

<sup>[1]</sup> The length of the phrase is commonly 12 words however it can be set to 24 for added security although I feel that benefit is outweighed by the shorter, more ergononmic 12 word phrase.

As part of this change should we also phase out the ability to download the key files themselves - opting to purely use the phrase as a backup?

## Future possibilities

[future-possibilities]: #future-possibilities

A significant improvement could be made by using the seed/key generated by the **Secret Phrase** to create a HD Key structure as per [BIP-0032](https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki) (an implementation of [BIP-044](https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki) which builds on BIP-0032 already exists in the [JS SDK](https://github.com/casper-ecosystem/casper-js-sdk/blob/master/src/lib/CasperHDKey.ts "CasperHDKey.ts")). The user would only need to manage one secret instead of a secret key file or **Secret Phrase** per keypair.
This could allow us to phase out the feature that allows key files to be downloaded, as improper storage of such files poses a serious security risk.  

[metamask]: https://metamask.io/ "MetaMask"
[signer_link]: https://chrome.google.com/webstore/detail/casperlabs-signer/djhndpllfiibmcdbnmaaahkhchcoijce "Casperlabs Signer"
[bip-39_wiki]:  https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki "BIP-39 Wiki"
[bip39_js]: https://github.com/bitcoinjs/bip39 "JavaScript implementation of BIP39"
